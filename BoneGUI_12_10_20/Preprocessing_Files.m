%% Preprocessing_Files()%% mida group http://mida.dima.unige.it - 2010/2015%%%% this function preprocesses the dicom files in the folder defined in inputpath%%%% It runs if only a Info.mat file does not exist yet%%%% Dicom files are read and information about the acquisition, the slice%%%% location, patients data are stored in Info.mat%%%% called by: Load_Data()function Preprocessing_Files()global Info;global pet_gui;FilesList = dir(Info.InputPath);while FilesList(1).name(1) == '.'    FilesList(1) = [];end%pet_gui.PANELwaitbar.waitbar = %waitbar2a(0,pet_gui.PANELwaitbar.panel);number_of_file = length(FilesList);temp_index   = zeros(number_of_file,5);for it = 1 : number_of_file    if ~mod(it,20)        %waitbar2a(it/number_of_file, pet_gui.PANELwaitbar.waitbar,'Preprocessing files...');    end    INFO = dicominfo([Info.InputPath,pet_gui.slash_pc_mac, FilesList(it).name]);    if isfield(INFO,'SliceLocation') %&& ~isempty(INFO.SeriesNumber)        temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,INFO.SliceLocation, it, INFO.ImagePositionPatient(3)];%     elseif isfield(INFO,'SliceLocation')%         INFO.SeriesNumber = 1;%         temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,INFO.SliceLocation, it, INFO.ImagePositionPatient(3)];%     elseif isfield(INFO,'InstanceNumber')%         INFO.SeriesNumber = 1; % daniela%         temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,0, it, 0];%     else%         INFO.SeriesNumber = 1; % daniela%         INFO.InstanceNumber = it; % daniela%         temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,0, it, 0];       %% MODIFICATA DA CRISTINA IL 18 SETTEMBRE 2019    else        if isfield(INFO,'ImagePositionPatient')              temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber,INFO.ImagePositionPatient(3), it, INFO.ImagePositionPatient(3)];        else              temp_index(it,:) = [INFO.SeriesNumber , INFO.InstanceNumber, 0, it, 0];        end    end        temp_modality{it} = INFO.Modality;end%waitbar2a(0, pet_gui.PANELwaitbar.waitbar,' ');clear INFO;temp_index = sortrows(temp_index);[~,index_cambio_acquisizione_start] = unique(temp_index(:,1),'first');[~,index_cambio_acquisizione_end] = unique(temp_index(:,1),'last');count_CTSeries = 1;count_PTSeries = 1;count_NMSeries = 1;for t = 1:length(index_cambio_acquisizione_start)    index1 = index_cambio_acquisizione_start(t);    index2 = index_cambio_acquisizione_end(t);        temp_modality{temp_index(index1,4)}    switch temp_modality{temp_index(index1,4)}        case 'PT'            if temp_index(index1,5)>temp_index(index2,5)                Info.LocationPT{count_PTSeries} = temp_index(index1:index2,5);                Info.FilePT{count_PTSeries}  = FilesList(temp_index(index1:index2,4));            else                Info.LocationPT{count_PTSeries} = temp_index(index2:-1:index1,5);                Info.FilePT{count_PTSeries}  = FilesList(temp_index(index2:-1:index1,4));            end            Info.NumberFilePT(count_PTSeries) = length(Info.FilePT{count_PTSeries});            Info.SeriesNumberPT(count_PTSeries) = temp_index(index1,1);                        INFO1 = dicominfo([Info.InputPath, pet_gui.slash_pc_mac, Info.FilePT{count_PTSeries}(1).name]);                        if index1<index2                Info.SliceThicknessPT(count_PTSeries) = abs(Info.LocationPT{count_PTSeries}(2)-Info.LocationPT{count_PTSeries}(1))*0.1;                Info.SlopePT(count_PTSeries) = Info.LocationPT{count_PTSeries}(2)-Info.LocationPT{count_PTSeries}(1);                Info.InterceptPT(count_PTSeries) = Info.LocationPT{count_PTSeries}(1) - Info.SlopePT(count_PTSeries);            else                Info.SliceThicknessPT(count_PTSeries) = 0;                Info.SlopePT(count_PTSeries) = 0;                Info.InterceptPT(count_PTSeries) = 0;            end            Info.PixelSpacingPT{count_PTSeries} = [];            if isfield(INFO1,'PixelSpacing'), Info.PixelSpacingPT{count_PTSeries} = INFO1.PixelSpacing*0.1; end                        Info.SeriesDescriptionPT{count_PTSeries} = [];            if isfield(INFO1,'SeriesDescription'), Info.SeriesDescriptionPT{count_PTSeries} = INFO1.SeriesDescription; end                    case 'NM'            Info.FileNM{count_NMSeries}  = FilesList(temp_index(index1:index2,4));            INFO1 = dicominfo([Info.InputPath, pet_gui.slash_pc_mac, Info.FileNM{count_NMSeries}(1).name]);            Info.NumberFileNM(count_NMSeries) = INFO1.NumberOfSlices;            aux = INFO1.DetectorInformationSequence.Item_1.ImagePositionPatient(3):...                INFO1.SpacingBetweenSlices: ...                (double(INFO1.SpacingBetweenSlices)*(double(INFO1.NumberOfSlices)-1))+...                INFO1.DetectorInformationSequence.Item_1.ImagePositionPatient(3);            Info.LocationNM{count_NMSeries} = aux';            Info.SeriesNumberNM(count_NMSeries) = temp_index(index1,1);                                                            Info.SliceThicknessNM(count_NMSeries) = abs(Info.LocationNM{count_NMSeries}(2)-Info.LocationNM{count_NMSeries}(1))*0.1;            Info.SlopeNM(count_NMSeries) = Info.LocationNM{count_NMSeries}(2)-Info.LocationNM{count_NMSeries}(1);            Info.InterceptNM(count_NMSeries) = Info.LocationNM{count_NMSeries}(1) - Info.SlopeNM(count_NMSeries);                        Info.PixelSpacingNM{count_NMSeries} = [];            if isfield(INFO1,'PixelSpacing'), Info.PixelSpacingNM{count_NMSeries} = INFO1.PixelSpacing*0.1; end                        Info.SeriesDescriNMionNM{count_NMSeries} = [];            if isfield(INFO1,'SeriesDescriNMion'), Info.SeriesDescriNMionNM{count_NMSeries} = INFO1.SeriesDescriNMion; end                        count_NMSeries = count_NMSeries+1;                    case 'CT'            Info.FileCT{count_CTSeries} = FilesList(temp_index(index1:index2,4));            Info.LocationCT{count_CTSeries} = temp_index(index1:index2,5);            Info.NumberFileCT(count_CTSeries) = length(Info.FileCT{count_CTSeries});            Info.SeriesNumberCT(count_CTSeries) = temp_index(index1,1);                        INFO1 = dicominfo([Info.InputPath, pet_gui.slash_pc_mac, Info.FileCT{count_CTSeries}(1).name]);                        if index1<index2                Info.SliceThicknessCT(count_CTSeries) = abs(Info.LocationCT{count_CTSeries}(2)-Info.LocationCT{count_CTSeries}(1))*0.1;                Info.SlopeCT(count_CTSeries) = Info.LocationCT{count_CTSeries}(2)-Info.LocationCT{count_CTSeries}(1);                Info.InterceptCT(count_CTSeries) = Info.LocationCT{count_CTSeries}(1) - Info.SlopeCT(count_CTSeries);                            else                Info.SliceThicknessCT(count_CTSeries) = 0;                Info.SlopeCT(count_CTSeries) = 0;                Info.InterceptCT(count_CTSeries) = 0;            end            Info.PixelSpacingCT{count_CTSeries} = [];            if isfield(INFO1,'PixelSpacing'), Info.PixelSpacingCT{count_CTSeries} = INFO1.PixelSpacing*0.1; end                        Info.SeriesDescriptionCT{count_CTSeries} = [];            if isfield(INFO1,'SeriesDescription'), Info.SeriesDescriptionCT{count_CTSeries} = INFO1.SeriesDescription; end                        count_CTSeries = count_CTSeries+1;    end        endInfo.PatientName.FamilyName = [];Info.PatientName.GivenName = [];Info.PatientSex = [];Info.PatientWeight = [];Info.PatientAge = [];Info.AcquisitionDate = [];INFO = dicominfo([Info.InputPath, pet_gui.slash_pc_mac, FilesList(1).name]);if isfield(INFO,'PatientName')    Info.PatientName.FamilyName = INFO.PatientName.FamilyName;    if isfield(INFO.PatientName,'GivenName')        Info.PatientName.GivenName = INFO.PatientName.GivenName;    end    endif isfield(INFO,'PatientSex'), Info.PatientSex = INFO.PatientSex; endif isfield(INFO,'PatientWeight'), Info.PatientWeight = num2str(INFO.PatientWeight); endif isfield(INFO,'PatientAge'), Info.PatientAge = num2str(str2double(INFO.PatientAge(:))); endif isfield(INFO,'AcquisitionDate'), Info.AcquisitionDate = INFO.AcquisitionDate; endInfo.PatientID = INFO1.PatientID;end